---
- name: Setup new user on server
  hosts: api
  become: true
  tasks:
    - name: Ensure the new user exists
      ansible.builtin.user:
        name: genry_bolit
        comment: "New user for administration"
        create_home: yes
        shell: /bin/bash

    - name: Add the user to sudo group
      ansible.builtin.user:
        name: genry_bolit
        groups: sudo
        append: yes

    - name: Set password for the user
      ansible.builtin.command:
        cmd: echo "genry_bolit:<password>" | chpasswd
        creates: /home/genry_bolit

    - name: Authorize SSH key for the new user
      ansible.builtin.file:
        path: /home/genry_bolit/.ssh
        state: directory
        mode: 0700
        owner: genry_bolit
        group: genry_bolit

    - name: Add multiple public keys to authorized_keys
      ansible.builtin.copy:
        dest: /home/genry_bolit/.ssh/authorized_keys
        content: "{{ ssh_keys | join('\n') }}"
        owner: genry_bolit
        group: genry_bolit
        mode: 0600

    - name: Ensure sudoers file allows passwordless sudo
      ansible.builtin.lineinfile:
        path: /etc/sudoers
        regexp: '^%sudo'
        line: '%sudo ALL=(ALL) NOPASSWD:ALL'
        validate: 'visudo -cf %s'
